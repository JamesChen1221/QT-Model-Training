# 可信度整合說明

## 📋 更新內容

已成功將預測可信度計算功能整合到 `predict_new_stocks.py` 中。

---

## 🎯 新增功能

### 1. 可信度計算

使用 Bootstrap 方法估計預測的不確定性，包含：

- **可信度分數**（0-1）：綜合評估預測的可靠程度
- **可信度等級**（高/中/低）：便於快速判斷
- **95% 預測區間**：預測值的可能範圍
- **資料相似度**：新資料與訓練資料的相似程度

### 2. 可信度計算方法

```python
可信度分數 = 0.4 × 預測區間分數 + 0.3 × 相似度分數 + 0.3 × 一致性分數
```

**各項指標：**

1. **預測區間分數**（40% 權重）
   - 區間寬度 < 10% → 高分
   - 區間寬度 > 20% → 低分

2. **相似度分數**（30% 權重）
   - 使用 K-近鄰（K=5）計算與訓練資料的距離
   - 距離越近 → 相似度越高

3. **一致性分數**（30% 權重）
   - Bootstrap 30 次的預測標準差
   - 標準差 < 3% → 高分
   - 標準差 > 6% → 低分

### 3. 可信度等級

| 等級 | 分數範圍 | 建議 |
|-----|---------|------|
| 高 | > 0.7 | 可以信賴預測結果，建議採取行動 |
| 中 | 0.4-0.7 | 謹慎評估，建議結合其他分析方法 |
| 低 | < 0.4 | 預測不確定性高，建議觀望 |

---

## 🚀 使用方法

### 方法 1: 使用批次檔（推薦）

```bash
# 基本預測（快速，不含可信度）
雙擊 快速預測.bat

# 預測含可信度（較慢，約 2-5 分鐘）
雙擊 快速預測_含可信度.bat
```

### 方法 2: 使用命令列

```bash
# 基本預測（快速）
python predict_new_stocks.py --input "data/Stock TBP.xlsx"

# 預測含可信度
python predict_new_stocks.py --input "data/Stock TBP.xlsx" --confidence

# 指定訓練資料位置（如果不在預設位置）
python predict_new_stocks.py --input "data/Stock TBP.xlsx" --confidence --training-data "data/QT Training Data.xlsx"
```

### 方法 3: 在程式中使用

```python
from predict_new_stocks import predict_stocks

# 預測並計算可信度
result = predict_stocks(
    input_file='data/Stock TBP.xlsx',
    model_dir='models/',
    output_file='data/new_predictions.csv',
    calculate_confidence=True,
    training_data_file='data/QT Training Data.xlsx'
)
```

---

## 📊 輸出結果

### 基本預測（不含可信度）

```csv
開盤日期,公司代碼,產業,預測_#開盤 (%),預測_#10分鐘低價 (%),預測_#1.5小時高價 (%),預測_#最高價前的最低價 (%)
2024-01-15,AAPL,10,2.46,-1.87,0.31,-1.94
```

### 預測含可信度

```csv
開盤日期,公司代碼,產業,預測_#開盤 (%),可信度_#開盤 (%),可信度等級_#開盤 (%),預測下界_#開盤 (%),預測上界_#開盤 (%),...
2024-01-15,AAPL,10,2.46,0.65,中,-0.82,5.74,...
```

**新增欄位說明：**

- `可信度_#開盤 (%)`: 可信度分數（0-1）
- `可信度等級_#開盤 (%)`: 可信度等級（高/中/低）
- `預測下界_#開盤 (%)`: 95% 預測區間下界
- `預測上界_#開盤 (%)`: 95% 預測區間上界

每個目標（開盤、10分鐘低價、1.5小時高價、最高價前的最低價）都會有對應的可信度欄位。

---

## ⚠️ 重要提醒

### 1. 計算時間

- **基本預測**：幾秒鐘
- **含可信度**：2-5 分鐘（取決於資料量和預測筆數）
  - Bootstrap 30 次 × 4 個模型 × 預測筆數

### 2. 資料量影響

當前訓練資料量：31 筆

**影響：**
- ✅ 可信度計算可以正常運行
- ⚠️ 所有預測的可信度都會偏低（< 0.5）
- ⚠️ 預測區間會很寬（不確定性高）

**建議：**
- 資料量 < 100 筆：可以不用計算可信度（都會偏低）
- 資料量 > 100 筆：建議使用可信度篩選預測結果
- 資料量 > 500 筆：可信度會更可靠

### 3. 可信度低的原因

如果某個預測的可信度很低，可能是因為：

1. **資料相似度低**
   - 新資料與訓練資料差異較大
   - 例如：訓練資料都是科技股，預測消費股

2. **預測區間寬**
   - Bootstrap 結果分散
   - 模型對這個樣本不確定

3. **模型不一致**
   - 不同 Bootstrap 迭代的預測差異大
   - 標準差 > 6%

4. **訓練資料量不足**
   - 整體資料量 < 100 筆
   - 所有預測的可信度都會偏低

---

## 📈 使用建議

### 1. 何時使用可信度計算？

| 訓練資料量 | 建議 |
|-----------|------|
| < 50 筆 | 不建議使用（可信度都會很低） |
| 50-100 筆 | 可以使用，但參考價值有限 |
| 100-500 筆 | 建議使用，可以篩選預測結果 |
| > 500 筆 | 強烈建議使用，可信度較可靠 |

### 2. 如何使用可信度？

**策略 1: 篩選高可信度預測**

```python
# 只採用高可信度的預測
high_confidence = result[result['可信度_#開盤 (%)'] > 0.7]
```

**策略 2: 根據可信度調整倉位**

```
可信度 > 0.7 → 正常倉位
可信度 0.4-0.7 → 減半倉位
可信度 < 0.4 → 觀望
```

**策略 3: 結合預測區間**

```
預測值 = 2.46%
預測區間 = [-0.82%, 5.74%]

→ 即使預測值為正，但下界為負
→ 有可能虧損，需要謹慎
```

### 3. 決策流程

```
1. 查看預測值
   ↓
2. 查看可信度等級
   ↓
3. 如果可信度高（> 0.7）
   → 可以信賴預測
   ↓
4. 如果可信度中（0.4-0.7）
   → 查看預測區間
   → 結合其他分析
   ↓
5. 如果可信度低（< 0.4）
   → 建議觀望
```

---

## 🔧 技術細節

### Bootstrap 方法

```python
for i in range(30):  # Bootstrap 30 次
    # 1. 重採樣訓練資料
    indices = np.random.choice(len(X_train), len(X_train), replace=True)
    X_boot = X_train[indices]
    y_boot = y_train[indices]
    
    # 2. 訓練模型
    boot_model = xgb.XGBRegressor(...)
    boot_model.fit(X_boot, y_boot)
    
    # 3. 預測
    pred = boot_model.predict(X_new)
    predictions.append(pred)

# 4. 計算統計量
mean_pred = predictions.mean()
std_pred = predictions.std()
lower_95 = np.percentile(predictions, 2.5)
upper_95 = np.percentile(predictions, 97.5)
```

### 相似度計算

```python
# 使用 K-近鄰（K=5）
nn = NearestNeighbors(n_neighbors=5)
nn.fit(X_train_scaled)

# 計算距離
distances, _ = nn.kneighbors(X_new_scaled)
avg_distance = distances.mean()

# 標準化（0-1）
max_distance = np.linalg.norm(X_train_scaled.max() - X_train_scaled.min())
similarity_score = 1 - (avg_distance / max_distance)
```

---

## 📝 範例輸出

### 控制台輸出

```
============================================================
QT 當沖潛力預測系統 - 多目標預測
============================================================

⚠ 可信度計算模式已啟用（需要較長時間）
載入訓練資料: data/QT Training Data.xlsx
✓ 訓練資料載入完成: 31 筆

步驟 1: 載入模型
✓ 找到 4 個模型:
  • #開盤 (%)                      ← qt_model_開盤_pct.pkl
  • #10分鐘低價 (%)                ← qt_model_10分鐘低價_pct.pkl
  • #1.5小時高價 (%)               ← qt_model_1.5小時高價_pct.pkl
  • #最高價前的最低價 (%)          ← qt_model_最高價前的最低價_pct.pkl

步驟 2: 載入新資料
輸入檔案: data/Stock TBP.xlsx
✓ 載入資料: 5 筆記錄
✓ 欄位數: 28

步驟 3: 預測 #開盤 (%)
------------------------------------------------------------
資料預處理...
✓ 從 120天收盤價序列提取趨勢斜率特徵...
✓ 成功提取 15 個趨勢斜率特徵
✓ 產業欄位已轉換為 One-Hot Encoding (13 個類別)
✓ 預處理完成，特徵數: 40
✓ 預測完成
  計算可信度...
✓ 可信度計算完成

... (其他 3 個模型)

============================================================
預測結果總覽
============================================================

開盤日期    公司代碼  產業  預測_#開盤 (%)  可信度等級_#開盤 (%)  ...
2024-01-15  AAPL     10    2.46           中                    ...
2024-01-15  MSFT     10    3.12           高                    ...
2024-01-15  GOOGL    10    1.87           中                    ...
2024-01-15  TSLA     11    4.56           低                    ...
2024-01-15  NVDA     10    5.23           中                    ...

============================================================
預測統計摘要
============================================================
預測筆數: 5

#開盤 (%):
  平均值:     3.45%
  標準差:     1.23%
  最大值:     5.23%
  最小值:     1.87%
  平均可信度:  0.58
  可信度分布:
    高: 1 筆
    中: 3 筆
    低: 1 筆

... (其他 3 個目標)

============================================================
✓ 預測完成！
============================================================
```

---

## 🎓 延伸閱讀

- **預測可信度分析.md** - 可信度計算的理論基礎
- **可信度實作範例.py** - 獨立的可信度計算範例
- **特徵數量與資料量關係分析.md** - 為什麼資料量影響可信度

---

## ✅ 總結

1. ✅ 可信度計算已整合到 `predict_new_stocks.py`
2. ✅ 使用 `--confidence` 參數啟用
3. ✅ 創建了 `快速預測_含可信度.bat` 批次檔
4. ✅ 更新了 README.md 說明文件
5. ✅ 輸出包含可信度分數、等級、預測區間

**建議：**
- 資料量 < 100 筆：可以不用計算可信度
- 資料量 > 100 筆：建議使用可信度篩選預測
- 可信度高的預測更值得參考

---

**祝你交易順利！** 🚀
